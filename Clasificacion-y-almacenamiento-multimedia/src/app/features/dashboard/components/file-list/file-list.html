<div class="file-list-container">
  <h2>Gesti√≥n de Archivos Multimedia</h2>

  <div class="filters-section">
    <input
      type="text"
      placeholder="üîñ Buscar por etiquetas..."
      [(ngModel)]="tagTerm"
      (input)="onSearch()"
      class="tag-search-input"
    />

    <select [(ngModel)]="selectedTipo" (change)="onFilterChange()">
      <option value="">Todos los tipos</option>
      <option value="imagen">Imagen</option>
      <option value="video">Video</option>
      <option value="audio">Audio</option>
      <option value="documento">Documento</option>
    </select>

    <select [(ngModel)]="selectedAccessLevel" (change)="onFilterChange()">
      <option value="">Todos los accesos</option>
      <option value="p√∫blico">P√∫blico</option>
      <option value="restringido">Restringido</option>
      <option value="privado">Privado</option>
    </select>

    <button (click)="resetFilters()">Reiniciar filtros</button>
  </div>

  <ng-container *ngIf="(archivos$ | async) as data; else loadingOrEmpty">
    <div *ngIf="data.archivos && data.archivos.length > 0; else noFiles">
      <div class="file-grid">
        <div
          class="file-card"
          *ngFor="let archivo of data.archivos"
          (click)="mostrarDetalle(archivo)"
        >
          <ng-container [ngSwitch]="archivo.tipo">
            <img *ngSwitchCase="'imagen'" [src]="getFileUrl(archivo.ruta_storage)" alt="Preview" class="file-thumbnail" />
            <video *ngSwitchCase="'video'" [src]="getFileUrl(archivo.ruta_storage)" muted class="file-thumbnail"></video>
            <audio *ngSwitchCase="'audio'" class="file-thumbnail" src="" disabled></audio>
            <div *ngSwitchCase="'documento'" class="file-icon"><i class="fas fa-file-alt fa-3x"></i></div>
            <div *ngSwitchDefault class="file-icon"><i class="fas fa-file fa-3x"></i></div>
          </ng-container>

          <div class="file-name">{{ archivo.titulo_archivo || archivo.nombre_archivo }}</div>

          <div class="file-badges">
            <span class="badge tipo">
              {{
                archivo.tipo === 'imagen' ? 'üì∑ Imagen' :
                archivo.tipo === 'video' ? 'üé• Video' :
                archivo.tipo === 'audio' ? 'üéß Audio' :
                archivo.tipo === 'documento' ? 'üìÑ Documento' : 'üìÅ Archivo'
              }}
            </span>
            <span class="badge acceso" [ngClass]="{
              publico: archivo.nivel_acceso === 'p√∫blico',
              restringido: archivo.nivel_acceso === 'restringido',
              privado: archivo.nivel_acceso === 'privado'
            }">
              {{
                archivo.nivel_acceso === 'p√∫blico' ? 'üîì P√∫blico' :
                archivo.nivel_acceso === 'restringido' ? 'üîê Restringido' :
                'üö´ Privado'
              }}
            </span>
          </div>
        </div>
      </div>

      <div class="pagination-controls" *ngIf="data.pagination && data.pagination.pages > 1">
        <button (click)="goToPage(data.pagination.page - 1)" [disabled]="data.pagination.page === 1">Anterior</button>
        <button
          *ngFor="let page of getPagesArray(data.pagination.page, data.pagination.pages)"
          [class.active]="page === data.pagination.page"
          (click)="goToPage(page)"
        >
          {{ page }}
        </button>
        <button (click)="goToPage(data.pagination.page + 1)" [disabled]="data.pagination.page === data.pagination.pages">Siguiente</button>
      </div>

      <div class="modal-backdrop" *ngIf="archivoSeleccionado">
        <div class="modal-content">
          <button class="modal-close" (click)="cerrarModal()">√ó</button>
          <img
            *ngIf="archivoSeleccionado.tipo === 'imagen'"
            [src]="getFileUrl(archivoSeleccionado.ruta_storage)"
            class="modal-img"
          />
          <video
            *ngIf="archivoSeleccionado.tipo === 'video'"
            [src]="getFileUrl(archivoSeleccionado.ruta_storage)"
            class="modal-img"
            controls
          ></video>
          <div class="modal-info">
            <h3>{{ archivoSeleccionado.titulo_archivo || archivoSeleccionado.nombre_archivo }}</h3>
            <p><strong>Nombre Original:</strong> {{ archivoSeleccionado.nombre_archivo }}</p> <p><strong>Tipo:</strong> {{ archivoSeleccionado.tipo }}</p>
            <p><strong>Categor√≠a:</strong> {{ archivoSeleccionado.categoria_nombre || 'N/A' }}</p>
            <p><strong>Acceso:</strong> {{ archivoSeleccionado.nivel_acceso }}</p>
            <p><strong>Fuente:</strong> {{ archivoSeleccionado.fuente || 'N/A' }}</p>
            <p><strong>Usuario:</strong> {{ archivoSeleccionado.usuario_nombre || 'N/A' }}</p>
            <p><strong>Visualizaciones:</strong> {{ archivoSeleccionado.views || 0 }}</p>
            <p><strong>Descargas:</strong> {{ archivoSeleccionado.downloads || 0 }}</p>
            <button class="download-btn" (click)="descargarArchivo(archivoSeleccionado)">
              <i class="fas fa-download"></i> Descargar
            </button>
          </div>
        </div>
      </div>
    </div>

    <ng-template #noFiles>
      <div class="no-files-message">No se encontraron archivos con los criterios de b√∫squeda.</div>
    </ng-template>
  </ng-container>

  <ng-template #loadingOrEmpty>
    <div class="loading-spinner" *ngIf="isLoading">Cargando archivos...</div>
    <div class="no-files-message" *ngIf="!isLoading && !error">No hay archivos para mostrar.</div>
    <div class="error-message" *ngIf="error">{{ error }}</div>
  </ng-template>
</div>